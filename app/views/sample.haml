=content_for(:head) do
  %script{:src => "/javascripts/web-socket-js/swfobject.js", :type => "text/javascript"}
  %script{:src => "/javascripts/web-socket-js/FABridge.js", :type => "text/javascript"}
  %script{:src => "/javascripts/web-socket-js/web_socket.js", :type => "text/javascript"}
  = puts WEBSOCKET_SERVER_CONFIG
  :javascript
    // Set URL of your WebSocketMain.swf here:
    WEB_SOCKET_SWF_LOCATION = "/javascripts/web-socket-js/WebSocketMain.swf";
    // Set this to dump debug message from Flash to console.log:
    WEB_SOCKET_DEBUG = true;

    var ws;
  
    function init() {

      // Connect to Web Socket.
      // Change host/port here to your own Web Socket server.
      ws = new WebSocket("ws://#{WEBSOCKET_SERVER_CONFIG["host"]}:#{WEBSOCKET_SERVER_CONFIG["port"]}/");

      // Set event handlers.
      ws.onopen = function() {
        output("onopen");
      };
      ws.onmessage = function(e) {
        // e.data contains received string.
        $("#status").hide('fast');
        $("#impact_form").show('fast');
        output(e.data);
      };
      ws.onclose = function() {
        output("onclose");
      };
      ws.onerror = function() {
        output("onerror");
      };

    }
  
    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);

      $("#status").html("Impact analysis started...")
      $("#status").show('fast');     
      $("#log").hide('fast');
      $("#impact_form").hide('fast');
      
      input.value = "";
      input.focus();
    }
  
    function onCloseClick() {
      ws.close();
    }
  
    function output(str) {
      var log = document.getElementById("log");
      log.innerHTML = str + "<br>"
      $("#log").show('fast');      
      $("#impact_form").show('slow');
    }
    
    $('document').ready(function () {
      init();
    })
#container
  #content
    #status.notice
      Loading...
    #impact_form{:style => "display:none"}
      %form{:onsubmit => "onSubmit(); return false;"}
        %input#input{:type => "text", :value => "[106,-7.5,107,-6]"}/ 
        %br
        %span.quiet.small enter bounding box e.g. [106,-7.5,107,-6]
        %br      
        %input{:type => "submit", :value => "Submit"}/
        %button{:onclick => "onCloseClick(); return false;"} close
    #log
