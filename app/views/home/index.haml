=content_for(:head) do
  / %script{:src => "http://api.maps.yahoo.com/ajaxymap?v=3.0&appid=euzuro-openlayers"}
  / %script{:src => "http://dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.2&mkt=en-us"}
  %script{:src => "http://maps.google.com/maps/api/js?sensor=false"}
  = javascript_include_tag 'home_index_map'

.pagehead
  %p
    The Hazard Impact Tool allows rapid impact assessments at the district level for
    a range of hazards and scenarios. Select the hazard and the scenario and the tool
    will provide estimates of people impacted in each district.

.container  
  #builder
    .map
      %h2 Choose an area
      %p Set the map below to the bounding box you want
      %p.bounding_box
      %p
        %span.width
        %span.height
      
    .hazard
      %h2 Select natural hazard
      %select
        =Hazard.layernames.each do |hz| 
          %option{:value => "#{hz}"}=hz.humanize
      %p.help
        I am some helpful text about what natural hazard means
    .exposure
      %h2 Select exposure
      %select
        =Exposure.layernames.each do |e| 
          %option{:value => "#{e}"}=e.humanize
      %p.help
        I am some helpful text about what exposure means
    .action
      %button{:type => 'submit'} Run simulation
      // %button.disabled{:type => 'submit'} Run simulation
    .loading
      %img{:src => '/images/spinner.gif'}
      %p Running simulation
    .results
      %h2 Impact results
      %p.timestamp Created at 15 July 2010, 1:31 PM
      %p.impact_layername
      .links
        %a.download{:href => '#'} Download results
        %a.ge{:href => '#'} View impact in Google Earth

#map-container

:javascript

  // Set URL of your WebSocketMain.swf here:
  WEB_SOCKET_SWF_LOCATION = "/javascripts/web-socket-js/WebSocketMain.swf";
  // Set this to dump debug message from Flash to console.log:
  WEB_SOCKET_DEBUG = true;
  var ws;

  function init_websocket() {
    // Connect to Web Socket.
    // Change host/port here to your own Web Socket server.
    ws = new WebSocket("ws://#{WEBSOCKET_SERVER_CONFIG["host"]}:#{WEBSOCKET_SERVER_CONFIG["port"]}/");

    // Set event handlers.
    ws.onopen = function() {
      console.log("onopen");
    };
    ws.onmessage = function(e) {
      // e.data contains received string.      
      results = JSON.parse(e.data);
      if (results.impact != null) {
        $('p.timestamp').html(results.impact.timestamp);
        $('p.impact_layername').html(results.impact.impact_layername);
        $('a.ge').attr('href', results.impact.kml);
        $('.loading').hide();    
        $('.results').show();

        var impact = new OpenLayers.Layer.WMS(results.impact.impact_layername.humanize(),
                   results.impact.wms,
                    {
                      layers: "impact:"+results.impact.impact_layername,
                      transparent: "true",
                      format: "image/png"
                    },
                   {isBaseLayer: false, visibility: true, opacity: 0.5}
                  ); 
        map.addLayer(impact);
        
      };
      console.log(e.data);
    };
    ws.onclose = function() {
      console.log("onclose");
    };
    ws.onerror = function() {
      console.log("onerror");
    };
  }

  $(document).ready(function(){
    init_home_index_map();
    init_websocket();
  });

  $('button').click(function() {
    if(Riat.olBounds().getWidth() > 10 )
    {
      alert("Extents are too big please zoom in");
      return null
    }
    $(this).addClass("disabled");
    $('.loading').show();
    Riat.hazard = $('.hazard select').val();
    Riat.exposure = $('.exposure select').val();
    console.log(Riat.bounding_box + "\n" + Riat.hazard + "\n" + Riat.exposure);
    encoded_riat = JSON.stringify(Riat);
    console.log(encoded_riat);
    ws.send(encoded_riat);
  })

